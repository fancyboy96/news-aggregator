<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script type="module">
        import { inject } from 'https://cdn.jsdelivr.net/npm/@vercel/analytics/+esm';
        inject();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            /* Slate-50 */
            color: #0f172a;
            /* Slate-900 */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .loader {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            /* Indigo-500 */
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Selection Mode Styles */
        .selection-mode .article-card {
            cursor: pointer;
        }

        .article-card.selected {
            box-shadow: 0 0 0 3px #6366f1;
            /* Indigo-500 */
            background-color: #eef2ff;
            /* Indigo-50 */
        }

        /* Custom Checkbox Style */
        .form-checkbox {
            border-radius: 6px;
            border-color: #cbd5e1;
        }

        /* Fade In Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>

<body
    class="min-h-screen selection:bg-indigo-100 selection:text-indigo-700 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300">

    <!-- API Key Modal Removed -->

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-6 py-16">

        <!-- Header -->
        <header class="text-center mb-16 animate-fade-in relative">
            <div class="absolute top-0 right-0">
                <button id="themeToggleBtn"
                    class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-slate-500 dark:text-slate-400">
                    <!-- Sun Icon (for Dark Mode) -->
                    <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    <!-- Moon Icon (for Light Mode) -->
                    <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                        </path>
                    </svg>
                </button>
            </div>
            <h1 class="text-6xl font-extrabold tracking-tight text-slate-900 dark:text-white mb-4">
                Currents<span class="text-indigo-500">.</span>
            </h1>

            <div
                class="mt-6 inline-flex items-center justify-center px-4 py-1.5 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm text-xs font-medium text-slate-400 dark:text-slate-500">
                <span id="currentProviderDisplay">Provider: NewsAPI</span>
            </div>
        </header>

        <!-- Search Section -->
        <div class="max-w-4xl mx-auto mb-12 animate-fade-in" style="animation-delay: 0.1s;">
            <div
                class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-none p-2 border border-slate-100 dark:border-slate-700 transition-colors">
                <form id="searchForm" class="flex flex-col md:flex-row gap-2">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="searchInput" required
                            class="w-full pl-11 pr-4 py-4 bg-transparent border-none rounded-2xl focus:ring-0 text-lg text-slate-800 dark:text-slate-100 placeholder-slate-400 outline-none"
                            placeholder="Search topics (e.g. 'technology', 'crypto')">
                    </div>

                    <div class="flex gap-2 p-1">
                        <button type="button" id="toggleFiltersBtn"
                            class="px-5 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 hover:text-slate-700 dark:hover:text-slate-200 font-medium transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                            </svg>
                            <span>Filters</span>
                        </button>
                        <button type="submit" id="searchBtn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-8 py-3 rounded-xl transition-all shadow-lg shadow-indigo-200 dark:shadow-indigo-900/40 hover:shadow-indigo-300 dark:hover:shadow-indigo-900/60 active:scale-95 flex items-center justify-center gap-2">
                            Search
                        </button>
                    </div>
                </form>

                <!-- Advanced Search Filters -->
                <div id="filterPanel"
                    class="hidden px-4 pb-6 pt-2 border-t border-slate-100 dark:border-slate-700 mt-2">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- News Provider -->
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Providers</label>
                            <div class="flex flex-col gap-3" id="providerContainer">
                                <label class="flex items-center cursor-pointer group">
                                    <input type="checkbox"
                                        class="form-checkbox text-indigo-600 rounded-md w-5 h-5 border-slate-300 focus:ring-indigo-500 provider-checkbox"
                                        value="newsapi" checked>
                                    <span
                                        class="ml-3 text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">NewsAPI.org
                                        <span id="count-newsapi" class="text-xs text-slate-400 ml-1"></span></span>
                                </label>
                                <label class="flex items-center cursor-pointer group">
                                    <input type="checkbox"
                                        class="form-checkbox text-indigo-600 rounded-md w-5 h-5 border-slate-300 focus:ring-indigo-500 provider-checkbox"
                                        value="newsdata" checked>
                                    <span
                                        class="ml-3 text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">NewsData.io
                                        <span id="count-newsdata" class="text-xs text-slate-400 ml-1"></span></span>
                                </label>
                                <label class="flex items-center cursor-pointer group">
                                    <input type="checkbox"
                                        class="form-checkbox text-indigo-600 rounded-md w-5 h-5 border-slate-300 focus:ring-indigo-500 provider-checkbox"
                                        value="gnews" checked>
                                    <span
                                        class="ml-3 text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">GNews.io
                                        <span id="count-gnews" class="text-xs text-slate-400 ml-1"></span></span>
                                </label>
                            </div>
                        </div>

                        <!-- Sort & Language -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Sort
                                    By</label>
                                <div class="relative">
                                    <select id="sortByInput"
                                        class="w-full pl-3 pr-10 py-2.5 bg-slate-50 dark:bg-slate-700 border-none rounded-lg text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-indigo-500 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors appearance-none">
                                        <option value="popularity" selected>Popularity</option>
                                        <option value="publishedAt">Newest</option>
                                        <option value="relevancy">Relevancy</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Language</label>
                                <div class="relative">
                                    <select id="languageInput"
                                        class="w-full pl-3 pr-10 py-2.5 bg-slate-50 dark:bg-slate-700 border-none rounded-lg text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-indigo-500 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors appearance-none">
                                        <option value="">All Languages</option>
                                        <option value="en" selected>English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dates & Options -->
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">From</label>
                                    <input type="date" id="fromInput"
                                        class="w-full px-3 py-2.5 bg-slate-50 dark:bg-slate-700 border-none rounded-lg text-sm text-slate-600 dark:text-slate-200 focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">To</label>
                                    <input type="date" id="toInput"
                                        class="w-full px-3 py-2.5 bg-slate-50 dark:bg-slate-700 border-none rounded-lg text-sm text-slate-600 dark:text-slate-200 focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Search
                                    In</label>
                                <div class="flex gap-4">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox"
                                            class="form-checkbox text-indigo-600 rounded w-4 h-4 border-slate-300"
                                            name="searchIn" value="title" checked>
                                        <span class="ml-2 text-sm text-slate-600 dark:text-slate-300">Title</span>
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox"
                                            class="form-checkbox text-indigo-600 rounded w-4 h-4 border-slate-300"
                                            name="searchIn" value="description" checked>
                                        <span class="ml-2 text-sm text-slate-600 dark:text-slate-300">Desc</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Domains (Full Width) -->
                        <div
                            class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4 pt-2 border-t border-slate-50 dark:border-slate-700">
                            <div>
                                <input type="text" id="domainsInput"
                                    placeholder="Specific Domains (e.g. techcrunch.com)"
                                    class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-700 border-none rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700 dark:text-slate-200 placeholder-slate-400">
                            </div>
                            <div>
                                <input type="text" id="excludeDomainsInput"
                                    placeholder="Exclude Domains (e.g. foxnews.com)"
                                    class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-700 border-none rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700 dark:text-slate-200 placeholder-slate-400">
                            </div>
                            <!-- Hidden Page Size for now to clean UI, default to 20 -->
                            <select id="pageSizeInput" class="hidden">
                                <option value="20" selected>20</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage"
                class="hidden mt-6 mx-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-xl text-red-600 dark:text-red-400 text-sm text-center font-medium">
            </div>
        </div>

        <!-- Selection Toolbar (Sticky) -->
        <div id="selectionToolbar"
            class="hidden sticky top-6 z-40 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md rounded-2xl shadow-2xl shadow-indigo-500/10 dark:shadow-none border border-indigo-100 dark:border-indigo-900 p-4 mb-12 flex justify-between items-center animate-fade-in max-w-2xl mx-auto">
            <div class="flex items-center gap-4">
                <span class="bg-indigo-600 text-white font-bold px-3 py-1 rounded-full text-sm shadow-sm"
                    id="selectionCount">0</span>
                <span class="text-slate-700 dark:text-slate-300 font-medium">articles selected</span>
            </div>
            <div class="flex gap-3">
                <button id="cancelSelectionBtn"
                    class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 font-medium px-4 py-2 transition-colors hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">
                    Cancel
                </button>
                <button id="generateDigestBtn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-xl transition-all shadow-lg shadow-indigo-200 dark:shadow-indigo-900/40 hover:shadow-indigo-300 dark:hover:shadow-indigo-900/60 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                    Generate Digest
                </button>
            </div>
        </div>

        <!-- Action Bar -->
        <div id="actionBar" class="flex justify-between items-center mb-8 hidden animate-fade-in">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">Top Stories</h2>
            <button id="startSelectionBtn"
                class="group text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 hover:text-indigo-700 dark:hover:text-indigo-300 font-semibold px-5 py-2.5 rounded-xl transition-all flex items-center gap-2 border border-indigo-100 dark:border-indigo-900 hover:border-indigo-200 dark:hover:border-indigo-800 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:scale-110 transition-transform"
                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                Create Email Digest
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingIndicator" class="hidden py-20 flex flex-col justify-center items-center gap-4">
            <div class="loader w-10 h-10 border-4"></div>
            <span class="text-slate-400 font-medium animate-pulse">Curating your feed...</span>
        </div>

        <!-- Results Grid -->
        <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16 hidden">
            <!-- Cards will be injected here -->
        </div>

        <!-- Digest Section -->
        <div id="digestSection"
            class="hidden bg-white dark:bg-slate-800 rounded-3xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden mb-16 animate-fade-in">
            <div
                class="p-6 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center flex-wrap gap-4 backdrop-blur-sm">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z">
                        </path>
                    </svg>
                    Digest Preview
                </h3>
                <button id="copyDigestBtn"
                    class="bg-slate-900 hover:bg-slate-800 text-white font-medium px-5 py-2.5 rounded-xl transition-all shadow-lg shadow-slate-200 hover:shadow-slate-300 flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    Copy to Clipboard
                </button>
            </div>
            <div class="p-0">
                <div id="digestContent"
                    class="digest-box w-full h-[500px] p-8 bg-white dark:bg-slate-800 font-mono text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap overflow-y-auto leading-relaxed">
                </div>
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-50 flex items-center gap-3 translate-y-4">
        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span class="font-medium">Copied to clipboard!</span>
    </div>

    <script>
        // --- State & Config ---
        // If hosted (e.g. Vercel), use the local proxy to avoid CORS/Free tier issues.
        // Note: Direct file:// access will fail as it cannot reach /api/proxy.
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';

        // We will determine the base URL dynamically based on the provider
        // const API_BASE_URL = ...; // Removed single constant

        // const STORAGE_KEY = 'newsapi_key'; // Deprecated in favor of dynamic keys
        let currentArticles = [];
        let currentQuery = '';
        let isSelectionMode = false;
        let selectedArticleIndices = new Set();
        let isSearching = false;

        // --- DOM Elements ---
        const els = {
            providerCheckboxes: document.querySelectorAll('.provider-checkbox'),
            currentProviderDisplay: document.getElementById('currentProviderDisplay'),
            searchForm: document.getElementById('searchForm'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            toggleFiltersBtn: document.getElementById('toggleFiltersBtn'),
            filterPanel: document.getElementById('filterPanel'),
            sortByInput: document.getElementById('sortByInput'),
            languageInput: document.getElementById('languageInput'),
            pageSizeInput: document.getElementById('pageSizeInput'),
            fromInput: document.getElementById('fromInput'),
            toInput: document.getElementById('toInput'),
            domainsInput: document.getElementById('domainsInput'),
            excludeDomainsInput: document.getElementById('excludeDomainsInput'),
            errorMessage: document.getElementById('errorMessage'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            resultsGrid: document.getElementById('resultsGrid'),
            digestSection: document.getElementById('digestSection'),
            digestContent: document.getElementById('digestContent'),
            copyDigestBtn: document.getElementById('copyDigestBtn'),
            toast: document.getElementById('toast'),
            // New Elements
            actionBar: document.getElementById('actionBar'),
            startSelectionBtn: document.getElementById('startSelectionBtn'),
            selectionToolbar: document.getElementById('selectionToolbar'),
            cancelSelectionBtn: document.getElementById('cancelSelectionBtn'),
            generateDigestBtn: document.getElementById('generateDigestBtn'),
            selectionCount: document.getElementById('selectionCount'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            sunIcon: document.getElementById('sunIcon'),
            moonIcon: document.getElementById('moonIcon')
        };

        // --- Theme Logic ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
                updateThemeIcon(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcon(false);
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            if (isDark) {
                els.sunIcon.classList.remove('hidden');
                els.moonIcon.classList.add('hidden');
            } else {
                els.sunIcon.classList.add('hidden');
                els.moonIcon.classList.remove('hidden');
            }
        }

        // --- Initialization ---
        function init() {
            initTheme();
            // Restore state from URL if present
            const params = new URLSearchParams(window.location.search);
            const query = params.get('q');

            if (query) {
                // Restore inputs
                els.searchInput.value = query;

                if (params.has('sortBy')) els.sortByInput.value = params.get('sortBy');
                if (params.has('language')) els.languageInput.value = params.get('language');
                if (params.has('pageSize')) els.pageSizeInput.value = params.get('pageSize');
                if (params.has('from')) els.fromInput.value = params.get('from');
                if (params.has('to')) els.toInput.value = params.get('to');
                if (params.has('domains')) els.domainsInput.value = params.get('domains');
                if (params.has('excludeDomains')) els.excludeDomainsInput.value = params.get('excludeDomains');

                // Restore providers
                if (params.has('provider')) {
                    const providers = params.get('provider').split(',');
                    els.providerCheckboxes.forEach(cb => {
                        cb.checked = providers.includes(cb.value);
                    });
                }

                // Restore "Search In" checkboxes
                if (params.has('searchIn')) {
                    const searchInValues = params.get('searchIn').split(',');
                    document.querySelectorAll('input[name="searchIn"]').forEach(cb => {
                        cb.checked = searchInValues.includes(cb.value);
                    });
                }

                updateProviderUI();

                // Auto-trigger search
                performSearch(query, false); // false = don't push state again on initial load
            } else {
                updateProviderUI();
            }
        }

        // --- Event Listeners ---
        // Add listeners to all provider checkboxes
        els.providerCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateProviderUI);
        });

        els.toggleFiltersBtn.addEventListener('click', () => {
            els.filterPanel.classList.toggle('hidden');
        });

        els.searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = els.searchInput.value.trim();
            if (query) {
                performSearch(query, true);
            }
        });

        els.copyDigestBtn.addEventListener('click', () => {
            const articlesToDigest = isSelectionMode
                ? currentArticles.filter((_, idx) => selectedArticleIndices.has(idx))
                : currentArticles; // Fallback if somehow called outside selection mode, though flow changed

            if (articlesToDigest.length > 0) {
                const digestText = generateDigestText(articlesToDigest, currentQuery);
                copyToClipboard(digestText);
            }
        });

        // Selection Mode Listeners
        els.startSelectionBtn.addEventListener('click', () => {
            setSelectionMode(true);
        });

        els.cancelSelectionBtn.addEventListener('click', () => {
            setSelectionMode(false);
        });

        els.generateDigestBtn.addEventListener('click', () => {
            const selected = currentArticles.filter((_, idx) => selectedArticleIndices.has(idx));
            if (selected.length > 0) {
                const digestText = generateDigestText(selected, currentQuery);
                els.digestContent.textContent = digestText;
                els.digestSection.classList.remove('hidden');
                // Scroll to digest
                els.digestSection.scrollIntoView({ behavior: 'smooth' });
            }
        });

        els.themeToggleBtn.addEventListener('click', toggleTheme);

        // --- Core Functions ---

        function updateProviderUI() {
            const selected = Array.from(els.providerCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.nextElementSibling.textContent);

            if (selected.length === 0) {
                els.currentProviderDisplay.textContent = 'Provider: None selected';
            } else {
                els.currentProviderDisplay.textContent = `Provider: ${selected.join(', ')}`;
            }
        }

        async function performSearch(query, pushState = true) {
            if (isSearching) {
                console.log('Search already in progress, skipping...');
                return;
            }

            const providers = Array.from(els.providerCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (providers.length === 0) {
                setError('Please select at least one news provider.');
                els.resultsGrid.classList.add('hidden');
                els.actionBar.classList.add('hidden');
                els.digestSection.classList.add('hidden');
                return;
            }

            // Update URL State
            if (pushState) {
                const params = new URLSearchParams();
                params.set('q', query);
                params.set('provider', providers.join(','));

                if (els.sortByInput.value) params.set('sortBy', els.sortByInput.value);
                if (els.languageInput.value) params.set('language', els.languageInput.value);
                if (els.pageSizeInput.value) params.set('pageSize', els.pageSizeInput.value);
                if (els.fromInput.value) params.set('from', els.fromInput.value);
                if (els.toInput.value) params.set('to', els.toInput.value);
                if (els.domainsInput.value) params.set('domains', els.domainsInput.value);
                if (els.excludeDomainsInput.value) params.set('excludeDomains', els.excludeDomainsInput.value);

                const searchIn = Array.from(document.querySelectorAll('input[name="searchIn"]:checked'))
                    .map(cb => cb.value)
                    .join(',');
                if (searchIn) params.set('searchIn', searchIn);

                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.pushState({ path: newUrl }, '', newUrl);
            }

            // Note: API Keys are now handled on the backend.
            // If running locally without a backend, this will fail unless mocked or proxied correctly.

            currentQuery = query;
            setLoading(true);
            isSearching = true;
            setError(null);
            els.resultsGrid.classList.add('hidden');
            els.digestSection.classList.add('hidden');
            els.actionBar.classList.add('hidden');
            setSelectionMode(false); // Reset selection on new search

            // Reset counts
            ['newsapi', 'newsdata', 'gnews'].forEach(p => {
                const el = document.getElementById(`count-${p}`);
                if (el) el.textContent = '';
            });

            try {
                // Fetch from all selected providers in parallel
                const promises = providers.map(async provider => {
                    try {
                        let data;
                        if (provider === 'newsdata') {
                            data = await fetchNewsData(query);
                        } else if (provider === 'gnews') {
                            data = await fetchGNews(query);
                        } else {
                            data = await fetchNewsApi(query);
                        }

                        // Update total count for this provider
                        const countEl = document.getElementById(`count-${provider}`);
                        if (countEl && data.totalResults !== undefined) {
                            countEl.textContent = `(${data.totalResults})`;
                        }
                        // Tag articles with provider source
                        if (data.articles) {
                            data.articles.forEach(a => a.apiSource = provider);
                        }
                        return data.articles || [];
                    } catch (err) {
                        console.error(`Failed to fetch from ${provider}:`, err);
                        // Return empty array on failure so other providers can still show results
                        // Optionally we could show a toast warning here
                        return [];
                    }
                });

                const resultsArrays = await Promise.all(promises);
                const allArticles = mergeResults(resultsArrays);

                if (allArticles.length > 0) {
                    console.log('Total articles to render:', allArticles.length);
                    currentArticles = allArticles;
                    renderResults(allArticles);

                    // Note: Digest is now hidden by default until user selects articles
                    // els.digestContent.textContent = digestText; 

                    els.resultsGrid.classList.remove('hidden');
                    // els.digestSection.classList.remove('hidden'); // Hidden by default now
                    els.actionBar.classList.remove('hidden'); // Show action bar
                } else {
                    setError('No articles found matching your criteria.');
                }

            } catch (err) {
                console.error('Search failed:', err);
                setError(err.message || 'An unexpected error occurred. Please try again.');
            } finally {
                setLoading(false);
                isSearching = false;
            }
        }

        function mergeResults(resultsArrays) {
            // Flatten array of arrays
            let merged = resultsArrays.flat();
            console.log('Merged raw results:', merged.length);

            // Remove duplicates (by Normalized URL or Title)
            const seen = new Set();
            merged = merged.filter(article => {
                if (!article.url && !article.title) return false;

                // Normalize URL: remove query parameters and trailing slashes
                let urlKey = '';
                if (article.url) {
                    try {
                        const urlObj = new URL(article.url);
                        urlKey = urlObj.origin + urlObj.pathname;
                        // Remove trailing slash
                        if (urlKey.endsWith('/')) urlKey = urlKey.slice(0, -1);
                    } catch (e) {
                        urlKey = article.url;
                    }
                }

                // Normalize Title: lowercase, remove special chars
                const titleKey = article.title ? article.title.toLowerCase().replace(/[^a-z0-9]/g, '') : '';

                // Check if we've seen this article
                // We prefer URL matching, but fallback to title if URL is missing or generic
                const key = urlKey || titleKey;

                // Also check titleKey specifically if we have one, to catch same article with different URLs
                if (titleKey && seen.has(titleKey)) return false;
                if (urlKey && seen.has(urlKey)) return false;

                if (urlKey) seen.add(urlKey);
                if (titleKey) seen.add(titleKey);

                return true;
            });
            console.log('Deduped results:', merged.length);

            // Sort by Date (Newest first)
            merged.sort((a, b) => {
                return new Date(b.publishedAt) - new Date(a.publishedAt);
            });

            return merged;
        }

        async function fetchNewsApi(query) {
            // Gather parameters
            const sortBy = els.sortByInput.value;
            const language = els.languageInput.value;
            const pageSize = els.pageSizeInput.value;
            const from = els.fromInput.value;
            const to = els.toInput.value;
            const domains = els.domainsInput.value.trim();
            const excludeDomains = els.excludeDomainsInput.value.trim();

            // Get checked "searchIn" values
            const searchIn = Array.from(document.querySelectorAll('input[name="searchIn"]:checked'))
                .map(cb => cb.value)
                .join(',');

            // Construct URL
            const params = new URLSearchParams();
            params.append('q', query);

            let url = '/api/proxy';
            params.append('provider', 'newsapi');

            if (sortBy) params.append('sortBy', sortBy);
            if (language) params.append('language', language);
            if (pageSize) params.append('pageSize', pageSize);
            if (from) params.append('from', from);
            if (to) params.append('to', to);
            if (domains) params.append('domains', domains);
            if (excludeDomains) params.append('excludeDomains', excludeDomains);
            if (searchIn && searchIn !== 'title,description,content') params.append('searchIn', searchIn);

            const data = await fetchWithRetry(`${url}?${params.toString()}`);

            if (data.status === 'error') {
                throw new Error(data.message || 'API Error');
            }

            return data;
        }

        async function fetchNewsData(query) {
            // NewsData.io mapping
            const language = els.languageInput.value;
            const sortBy = els.sortByInput.value;
            // NewsData uses 'size' instead of 'pageSize', max 50 for paid, 10 for free. We'll request what user asked but it might be capped.
            // NewsData domains are 'domain' parameter.
            const domains = els.domainsInput.value.trim();
            const excludeDomains = els.excludeDomainsInput.value.trim();

            const params = new URLSearchParams();
            params.append('q', query); // 'q' is same
            // params.append('full_content', '1'); // Removed: Paid-only feature causing 422 on free plans

            let url = '/api/proxy';
            params.append('provider', 'newsdata');

            if (language) params.append('language', language);
            if (domains) params.append('domain', domains);
            if (excludeDomains) params.append('excludedomain', excludeDomains);

            // Sorting Mapping
            // NewsData supports: pubdateasc, relevancy, source. Default is newest (pubdatedesc equivalent).
            if (sortBy === 'relevancy' || sortBy === 'popularity') {
                params.append('sort', 'relevancy');
            }
            // If sortBy is 'publishedAt' (Newest), we do nothing as it's the default.

            const data = await fetchWithRetry(`${url}?${params.toString()}`);

            if (data.status === 'error') {
                throw new Error(data.results?.message || data.message || 'API Error');
            }

            // Normalize to NewsAPI format
            return {
                status: 'ok',
                totalResults: data.totalResults,
                articles: (data.results || []).map(item => ({
                    source: { name: item.source_id || 'NewsData' },
                    author: item.creator ? item.creator[0] : null,
                    title: item.title,
                    description: item.description,
                    url: item.link,
                    urlToImage: item.image_url,
                    publishedAt: item.pubDate,
                    content: item.content
                }))
            };
        }

        async function fetchGNews(query) {
            // GNews mapping
            const language = els.languageInput.value;
            const sortBy = els.sortByInput.value;
            // GNews uses 'max' for page size (default 10, max 100)
            const pageSize = els.pageSizeInput.value;
            // GNews uses 'from' and 'to' in ISO 8601 format (e.g. 2022-08-21T16:27:09Z)
            const from = els.fromInput.value;
            const to = els.toInput.value;
            // GNews uses 'in' to specify where to search (title, description, content)

            const params = new URLSearchParams();
            params.append('q', query);

            let url = '/api/proxy';
            params.append('provider', 'gnews');

            if (language) params.append('lang', language);
            if (pageSize) params.append('max', pageSize);

            // Date formatting if needed. GNews takes "2023-01-01T00:00:00Z"
            if (from) {
                params.append('from', new Date(from).toISOString());
            } else {
                // GNews Free Plan limit: 1 month. Default to 1 month ago to avoid "historical data" errors with relevance sort.
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                params.append('from', oneMonthAgo.toISOString());
            }

            if (to) params.append('to', new Date(to).toISOString());

            // Sort mapping
            // GNews supports: publishedAt (default), relevance
            if (sortBy === 'relevancy' || sortBy === 'popularity') {
                params.append('sortby', 'relevance');
            } else {
                params.append('sortby', 'publishedAt');
            }

            // Search In mapping
            // Note: GNews 'in' parameter often causes empty results on free plans if it filters out too much or hits historical data limits.
            // We will omit it for now to ensure results are returned.
            /*
             const searchIn = Array.from(document.querySelectorAll('input[name="searchIn"]:checked'))
                .map(cb => cb.value);
            if (searchIn.length > 0) {
                // GNews uses 'in' parameter with values: title, description, content
                params.append('in', searchIn.join(','));
            }
            */

            console.log('Fetching GNews with params:', params.toString());

            const data = await fetchWithRetry(`${url}?${params.toString()}`);

            console.log('GNews Raw Response:', data);

            if (data.errors) {
                const msg = Array.isArray(data.errors) ? data.errors[0] : 'GNews API Error';
                throw new Error(msg);
            }

            if (data.status === 'error') {
                const msg = data.message || 'API Error';
                throw new Error(msg);
            }

            // Normalize to NewsAPI format
            return {
                status: 'ok',
                totalResults: data.totalArticles,
                articles: (data.articles || []).map(item => ({
                    source: { name: (item.source && item.source.name) || 'GNews' },
                    author: null, // GNews doesn't always provide author in the same way
                    title: item.title,
                    description: item.description,
                    url: item.url,
                    urlToImage: item.image,
                    publishedAt: item.publishedAt,
                    content: item.content
                }))
            };
        }

        async function fetchWithRetry(url, retries = 3, backoff = 300) {
            try {
                const response = await fetch(url);

                // Handle HTTP errors explicitly
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error(`API Key Error (${response.status})`);
                    }
                    if (response.status === 429) {
                        throw new Error('Rate limit reached. Please try again later.');
                    }
                    if (response.status === 426) {
                        throw new Error('NewsAPI does not allow requests from the file system (file://). Please run this app on a local server (e.g. localhost).');
                    }
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                return await response.json();

            } catch (error) {
                if (retries > 0 && !error.message.includes('API Key Error')) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, retries - 1, backoff * 2);
                }
                throw error;
            }
        }

        function highlightText(text, query) {
            if (!text || !query) return text || '';

            let regex;
            const isExactPhrase = query.startsWith('"') && query.endsWith('"');

            if (isExactPhrase) {
                // Exact phrase matching: strip quotes and match exact sequence
                const phrase = query.slice(1, -1);
                if (!phrase) return text;
                const safePhrase = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                // Use word boundaries if the phrase starts/ends with word characters
                regex = new RegExp(`(${safePhrase})`, 'gi');
            } else {
                // Multi-word matching: split into words
                const words = query.split(/\s+/).filter(w => w.length > 0);
                if (words.length === 0) return text;

                // Escape and sort by length desc
                const safeWords = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))
                    .sort((a, b) => b.length - a.length);

                // Use word boundaries (\b) to prevent partial matches like 'ey' in 'Valley'
                // We wrap each word in \b...\b, but we need to be careful with non-word chars.
                // If a search term contains non-word chars (e.g. "C++"), \b might not work as expected.
                // For simple alphanumeric queries, \b is best.

                const pattern = safeWords.map(w => {
                    // Check if word starts/ends with alphanumeric
                    const start = /^\w/.test(w) ? '\\b' : '';
                    const end = /\w$/.test(w) ? '\\b' : '';
                    return `${start}${w}${end}`;
                }).join('|');

                regex = new RegExp(`(${pattern})`, 'gi');
            }

            return text.replace(regex, '<mark class="bg-indigo-100 text-indigo-900 rounded-sm px-0.5">$1</mark>');
        }

        function getSnippet(content, query) {
            if (!content || !query) return null;
            const lowerContent = content.toLowerCase();
            const lowerQuery = query.toLowerCase();
            const index = lowerContent.indexOf(lowerQuery);

            if (index === -1) return null;

            // Extract window around the match
            const start = Math.max(0, index - 50);
            const end = Math.min(content.length, index + query.length + 50);
            let snippet = content.substring(start, end);

            // Add ellipsis
            if (start > 0) snippet = '...' + snippet;
            if (end < content.length) snippet = snippet + '...';

            return highlightText(snippet, query);
        }

        function setSelectionMode(active) {
            isSelectionMode = active;
            selectedArticleIndices.clear();
            updateSelectionUI();

            if (active) {
                els.selectionToolbar.classList.remove('hidden');
                els.actionBar.classList.add('hidden');
                els.digestSection.classList.add('hidden'); // Hide digest if open
                document.body.classList.add('selection-mode');
            } else {
                els.selectionToolbar.classList.add('hidden');
                els.actionBar.classList.remove('hidden');
                els.digestSection.classList.add('hidden'); // Hide digest when cancelling
                document.body.classList.remove('selection-mode');
            }
            // Re-render to show/hide checkboxes
            renderResults(currentArticles);
        }

        function toggleArticleSelection(index) {
            if (!isSelectionMode) return;

            if (selectedArticleIndices.has(index)) {
                selectedArticleIndices.delete(index);
            } else {
                selectedArticleIndices.add(index);
            }
            updateSelectionUI();

            // Update specific card UI without full re-render
            const card = document.getElementById(`article-${index}`);
            const checkbox = document.getElementById(`checkbox-${index}`);
            if (card && checkbox) {
                if (selectedArticleIndices.has(index)) {
                    card.classList.add('selected');
                    checkbox.checked = true;
                } else {
                    card.classList.remove('selected');
                    checkbox.checked = false;
                }
            }
        }

        function updateSelectionUI() {
            const count = selectedArticleIndices.size;
            els.selectionCount.textContent = count;
            els.generateDigestBtn.disabled = count === 0;
            els.generateDigestBtn.textContent = count > 0 ? `Generate Digest (${count})` : 'Generate Digest';
        }

        function renderResults(articles) {
            console.log('Rendering articles:', articles.length);
            els.resultsGrid.innerHTML = articles.map((article, index) => {
                const date = new Date(article.publishedAt).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric'
                });
                const image = article.urlToImage || 'https://placehold.co/600x400/f1f5f9/94a3b8?text=No+Image';

                // Apply highlighting
                const titleHtml = highlightText(article.title, currentQuery);
                const descHtml = highlightText(article.description, currentQuery);

                // Check for content snippet
                let contentSnippetHtml = '';
                if (article.content) {
                    const snippet = getSnippet(article.content, currentQuery);
                    if (snippet) {
                        contentSnippetHtml = `<div class="mt-4 p-3 bg-slate-50 dark:bg-slate-900 rounded-lg text-xs text-slate-500 dark:text-slate-400 font-mono border border-slate-100 dark:border-slate-700">
                            <span class="font-bold text-indigo-400 uppercase tracking-wider text-[10px] mr-2">Match:</span>
                            ${snippet}
                        </div>`;
                    }
                }

                const isSelected = selectedArticleIndices.has(index);
                const selectionOverlay = isSelectionMode ? `
                    <div class="absolute top-4 right-4 z-20">
                        <input type="checkbox" id="checkbox-${index}" class="w-6 h-6 rounded-md border-slate-300 text-indigo-600 focus:ring-indigo-500 transition-all cursor-pointer shadow-sm selection-checkbox" ${isSelected ? 'checked' : ''}>
                    </div>
                    <div class="absolute inset-0 bg-indigo-500/5 backdrop-blur-[1px] pointer-events-none transition-opacity duration-300 ${isSelected ? 'opacity-100' : 'opacity-0'}" id="overlay-${index}"></div>
                ` : '';

                const clickHandler = isSelectionMode ? `onclick="toggleArticleSelection(${index})"` : '';

                // Source Badge Color
                const sourceColorClass = article.apiSource === 'newsdata' ? 'bg-orange-100 text-orange-700' :
                    (article.apiSource === 'gnews' ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700');

                return `
                    <article id="article-${index}" class="article-card group bg-white dark:bg-slate-800 rounded-3xl shadow-sm hover:shadow-xl hover:shadow-slate-200/50 dark:hover:shadow-none transition-all duration-300 overflow-hidden flex flex-col h-full relative border border-slate-100 dark:border-slate-700 ${isSelected ? 'selected' : ''}" ${clickHandler}>
                        ${selectionOverlay}
                        <div class="h-56 overflow-hidden relative bg-slate-100 dark:bg-slate-700">
                             <img src="${image}" alt="${article.title}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700" onerror="this.onerror=null;this.src='https://placehold.co/600x400/f1f5f9/94a3b8?text=No+Image'">
                             <div class="absolute top-4 left-4 flex gap-2">
                                <span class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm text-slate-700 dark:text-slate-200 text-xs font-bold px-3 py-1.5 rounded-full shadow-sm border border-white/50 dark:border-slate-700/50">
                                    ${article.source.name || 'Unknown Source'}
                                </span>
                             </div>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-xs font-medium text-slate-400 dark:text-slate-500">${date}</span>
                                <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full ${sourceColorClass}">
                                    ${article.apiSource === 'newsdata' ? 'NewsData' : (article.apiSource === 'gnews' ? 'GNews' : 'NewsAPI')}
                                </span>
                            </div>
                            
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-3 leading-tight group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                                <a href="${article.url}" target="_blank" class="focus:outline-none ${isSelectionMode ? 'pointer-events-none' : ''}">
                                    ${titleHtml}
                                </a>
                            </h3>
                            
                            <p class="text-slate-600 dark:text-slate-300 text-sm mb-6 flex-1 line-clamp-3 leading-relaxed">
                                ${descHtml || 'No description available.'}
                            </p>
                            
                            ${contentSnippetHtml}
                            
                            <div class="mt-auto pt-4 border-t border-slate-50 dark:border-slate-700 flex justify-between items-center">
                                <a href="${article.url}" target="_blank" class="text-indigo-600 dark:text-indigo-400 text-sm font-bold hover:text-indigo-700 dark:hover:text-indigo-300 inline-flex items-center gap-1 group/link ${isSelectionMode ? 'pointer-events-none opacity-50' : ''}">
                                    Read full story 
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover/link:translate-x-1 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                <button onclick="shareArticle('${article.url}', event)" class="text-slate-400 hover:text-indigo-600 dark:text-slate-500 dark:hover:text-indigo-400 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 ${isSelectionMode ? 'pointer-events-none opacity-50' : ''}" title="Copy Link">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        async function shareArticle(url, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            try {
                await navigator.clipboard.writeText(url);
                showNotification('Link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy link.', true);
            }
        }

        function showNotification(message, isError = false) {
            // Remove existing toast if any
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `fixed bottom-8 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg text-white font-medium text-sm z-50 animate-fade-in transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-slate-900 dark:bg-white dark:text-slate-900'}`;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function generateDigestText(articles, query) {
            const date = new Date().toLocaleString('en-US');
            const separator = "=".repeat(60);
            const divider = "-".repeat(60);

            let text = `${separator}\nNEWS DIGEST\n${separator}\n`;
            text += `Topic: ${query}\n`;
            text += `Generated: ${date}\n`;
            text += `${separator}\n\n`;

            articles.forEach((article, index) => {
                text += `${index + 1}. ${article.title}\n`;
                text += `   Source: ${article.source.name}\n`;
                text += `   Link: ${article.url}\n`;
                if (article.description) {
                    text += `   Summary: ${article.description.replace(/\n/g, ' ')}\n`; // Flatten description
                }
                text += `\n${divider}\n\n`;
            });

            text += `End of Digest\n${separator}`;
            return text;
        }

        function copyToClipboard(text) {
            // Fallback for older browsers or non-secure contexts
            if (!navigator.clipboard) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";  // Avoid scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast();
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('Failed to copy to clipboard.');
                }
                document.body.removeChild(textArea);
                return;
            }

            // Modern API
            navigator.clipboard.writeText(text).then(function () {
                showToast();
            }, function (err) {
                console.error('Async: Could not copy text: ', err);
                alert('Failed to copy to clipboard.');
            });
        }

        function showToast() {
            els.toast.classList.remove('opacity-0');
            setTimeout(() => {
                els.toast.classList.add('opacity-0');
            }, 3000);
        }

        function setLoading(isLoading) {
            if (isLoading) {
                els.loadingIndicator.classList.remove('hidden');
                els.searchBtn.disabled = true;
                els.searchBtn.innerHTML = '<div class="loader" style="width:16px;height:16px;border-width:2px;"></div> Searching...';
            } else {
                els.loadingIndicator.classList.add('hidden');
                els.searchBtn.disabled = false;
                els.searchBtn.innerHTML = '<span>Search</span>';
            }
        }

        function setError(msg) {
            if (msg) {
                els.errorMessage.textContent = msg;
                els.errorMessage.classList.remove('hidden');
            } else {
                els.errorMessage.classList.add('hidden');
            }
        }

        // Run Init
        init();

    </script>
</body>

</html>